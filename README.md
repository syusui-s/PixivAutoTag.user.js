# PixivAutoTag.user.js
Pixivでブックマークタグ付け自動化してくれるUserScriptを書いたぞ！！

かなり細かくタグ付けルールを設定できるのでブックマークが捗ります。

なにができるの？
-----
* ブックマークタグ一覧（タグクラウド）に、作品タグが含まれていれば自動でそのブックマークタグを付与
* ルール文に基づいて、細かくブックマークタグを付与
	* (例) 短縮や別名のエイリアス 「CCさくら」->「カードキャプターさくら」、「アンチョビ」->「安斎千代美」
	* (例) 部分除去 「響(艦隊これくしょん)」->「響」
	* (例) 作品に基づくキャラの特定 「アリス」+「東方」->「アリス・マーガトロイド」、「アリス」+「ARIA」->「アリス・キャロル」
	* この他にも、たくさんの使い方ができます！

インストール方法
-----
### Chrome、ChromiumでTampermonkeyを使って導入する
1. UserScriptを利用できるようにするため、[Tampermonkey](https://chrome.google.com/webstore/detail/tampermonkey/dhdgffkkebhmkfjojejmpbldmpobfkfo?hl=ja)を導入する
2. <https://raw.githubusercontent.com/syusui-s/PixivAutoTag.user.js/master/pixiv_auto_tag.user.js>を開く
3. 「インストール」を押下する

### Chrome、Chromiumで拡張機能として導入する（Windows非対応）
1. pixiv\_auto\_tag.user.jsをダウンロードしておく
2. Chromeの設定→設定(S)→拡張機能の一覧を開く
3. 拡張機能の画面にファイラからpixiv\_auto\_tag.user.jsをドラッグ・アンド・ドロップする
4. 確認画面でOKを押す

### Firefoxに導入する
1. pixiv\_auto\_tag.user.jsをダウンロードしておく
2. UserScriptを利用できるようにするため、[GreaseMonkey](https://addons.mozilla.org/ja/firefox/addon/greasemonkey/)を導入する
3. about:addonsをアドレスバーに入力して開き、ユーザスクリプトの項目を開いておく
4. ユーザスクリプトの画面にファイラからpixiv\_auto\_tag.user.jsをドラッグ・アンド・ドロップする
5. 確認画面でインストールを押す

使い方
-----
* Pixivの「ブックマークに追加/ブックマークの編集」のページや画面（※）を開いたら、自動的にタグ付けと公開/非公開の設定がされます。
	* 自動的にタグ付けがなされると、タグの入力欄の枠が水色に変化します（自動タグ付けの可視化）。
	* 下記の"タグ付けルール"でタグの追加や削除、正規表現による検出と一致部分の抽出ができます。
	* デフォルトで、R-18を非公開に設定するようにしています。下記の"タグ付けルール"でこの動作を変更できます。
	* すでにブックマークタグが入力されていた場合は、何もしません。
* この作品のタグの横にある「タグ自動化設定」ボタンを押すと、設定画面が出てきます。
	* 設定の内容や設定方法については、下記の"設定画面の項目"をご覧ください。

※ Pixivのショートカットキー機能により、イラストページ上でBキーを押下すると、
ブックマーク画面がモーダルウィンドウとして出現します。
キーボードで楽にブックマークをしたい場合はおすすめです（が、まだ不安定です）。

仕組みと処理内容
-----
1. 作品タグに非公開設定タグが含まれていたら非公開に設定する。
2. 作品タグに対して、addition\_pattern系のルールが一致するかどうかを確認し、一致したら指定のタグを作品タグに追加する。
3. 作品タグとタグクラウドで共通するタグを抽出する。
4. 作品タグに対して、match系とpattern系のルールが一致するかどうかを確認し、一致したら指定のタグを付加タグリストに追加する。
5. 共通タグと付加タグリストの和集合を作成する。
6. 和集合から削除指定されたタグを除去する。

設定画面の項目
-----
設定画面で利用できる項目の説明です。

### タグ付けルール
タグ付けのルールを簡単な記法の文を使って記述することができる。
非公開タグを設定するprivate、タグを付与するmatch、patternが利用できる。

#### ルールの記法
* private      - 引数のタグが作品タグに含まれていたら非公開に設定する（記法：`private タグ1 タグ2 ...`）
* match        - 第二引数以降のいずれかのタグが作品タグに含まれていれば、付与タグを付加タグリストに追加する（記法：`match 付与タグ タグ1 ...`）
* match\_all   - 第二引数以降のすべてのタグが作品タグに含まれていれば、付与タグを付加タグリストに追加する（記法：`match_all 付与タグ タグ1 ...`）
* pattern      - 第二引数以降のいずれかの正規表現がいずれかの作品タグに一致すれば、付与タグを付加タグリストに追加する（記法：`pattern 付与タグ 正規表現1 ...`）
* pattern\_all - 第二引数以降のすべての正規表現がいずれかの作品タグに一致すれば、付与タグを付加タグリストに追加する（記法：`pattern_all 付与タグ 正規表現1 ...`）
* addition\_pattern      - 第二引数以降のいずれかの正規表現がいずれかの作品タグに一致すれば、付与タグを作品タグに追加する（記法：`addition_pattern 付与タグ 正規表現1 ...`
* addition\_pattern\_all - 第二引数以降のすべての正規表現がいずれかの作品タグに一致すれば、付与タグを作品タグに追加する（記法：`addition_pattern_all 付与タグ 正規表現1 ...`）

#### ルールの記法詳細
* コメント行の規則
	* 空行は無視される。
	* # で始まる行はコメント行とみなされ、無視される。
	* 整形のために # の前に空白文字を入れてもよい。前に来るのが空白文字でなければエラーとなる。
	* ルール行で # を用いることはできない。
* ルール文の規則
	* ルール文の区切りは空白文字である。
	* 整形のために区切り文字として空白文字を連続して使用してもよい。
	* 各ルール文ごとにルールの配列が作られ、ルールは先頭に近いものから順になっている。
	* ルール文の実行は、`addition_pattern`、`addition_pattern_all`、`pattern`+`match`、`pattern_all`+`match_all`の順に上から実行される。
* privateとmatchの規則
	* 作品タグに完全一致するものを書かなければならない。
* matchとpatternの規則
	* 一致すると、付与タグで指定したタグが、付与タグのリストに追加される。
	* 「-削除タグ」でタグを削除できる。タグクラウドに入っていようが消される。元からない場合は特に何もしない。
	* 付与したタグはタグクラウドに含まれていなくても反映される。
* patternの規則
	* 正規表現は、[JavaScriptのRegExp](https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Regular_Expressions)の引数を指定する。
	* `~番号`を使って、付与タグで[正規表現で一致した部分文字列](https://developer.mozilla.org/ja/docs/Web/JavaScript/Guide/Regular_Expressions#special-capturing-parentheses)を使用できる。正規表現中でキャプチャリングの括弧を使用して部分一致を指定する。番号には1から9までが指定できる。10以降は指定できない。
	* 正規表現にキャプチャリングを使わない場合でも、`~数字`が付与タグに含まれていた場合は空白文字に置換される。
	* 1つの文で複数の正規表現を指定している場合、部分文字列として参照されるデータには、**初めて**一致に成功したときのものが使われる。
* allの規則と通常のものとの違い
	* allは、第二引数以降の全ての正規表現やタグが、いずれかの作品タグに一致した場合にタグを付与する。
	* 通常のものは、作品タグ一覧に対してルールに一致するかを確かめるが、allはルール文の集合に対してタグがルールに一致するかを確かめる。
	* pattern\_allで正規表現を複数指定している場合、部分文字列として参照されるデータには、**最後に**一致に成功したときのものが使われる。
* addition\_patternの規則
	* 一致した場合は、付与タグが作品タグとして扱われるようになる。
	* これにより追加された付与タグは、`pattern`や`match`、all系のタグ付け対象となる。
	* その他は、patternの規則やallの規則を参照のこと。

#### ルールのサンプル
各パターンの利用例として、作者が使ってるルールの一部を抜粋してみました。
参考にしていただければ幸いです。

``` plain
# 非公開設定
private R-18 R-18G R-17.9 R-15

# 一般
pattern オリジナル   オリジナル

# 艦これ系
pattern     艦隊これくしょん 艦これ
pattern     ~1               ^(.+)(\(艦隊これくしょん\)|\(艦これ\))$
pattern_all ~1               ^艦これ$|^艦隊これくしょん$ ^(.+)(改|改二)$
match       響               ヴェールヌイ

# 東方系
match     魂魄妖夢                   妖夢
match     多々良小傘                 小傘
match     綿月依姫                   依姫
match     四季映姫・ヤマザナドゥ     四季映姫
match     西行寺幽々子               幽々子
match     古明地こいし               こいし
match     古明地さとり               さとり
match     博麗霊夢                   霊夢
match     霧雨魔理沙                 魔理沙
match     十六夜咲夜                 咲夜
match     洩矢諏訪子                 諏訪子
match     火焔猫燐                   お燐
match     霊烏路空                   お空
match     蓬莱山輝夜                 輝夜 ぐーや
match     レミリア・スカーレット     レミリア
match     フランドール・スカーレット フラン フランドール
match     ミスティア・ローレライ     みすちー ミスティア
match     パチュリー・ノーレッジ     パチュリー リュネット・パッチェ ぱちゅりー
match     眼鏡                       リュネット・パッチェ
match     鈴仙・優曇華院・イナバ     うどんげ 鈴仙 優曇華院
match_all アリス・マーガトロイド     アリス 東方

# アイドルマスター
match -アイドルマスター アイドルマスターシンデレラガールズ

# ご注文はうさぎですか？
match_all  保登心愛                   ご注文はうさぎですか? ココア
match_all  香風智乃                   ご注文はうさぎですか? チノ
match_all  桐間紗路                   ご注文はうさぎですか? シャロ
match_all  天々座理世                 ご注文はうさぎですか? リゼ
match_all  宇治松千夜                 ご注文はうさぎですか? 千夜
```

注意事項
-----
ローカルストレージを消さないように注意してください。
ローカルストレージにタグ付けルールを保存していますので、閲覧履歴の削除等で誤ってデータを消してしまうと、書いてきたルールがパーになります。
閲覧履歴を消す前は、どこか別の場所に保存しておくなど、対処のほどお願いします。データの紛失には対応できません。

要望・バグ報告・お問い合わせ
-----
要望やバグ報告は、[GitHubのIssueページ](https://github.com/syusui-s/PixivAutoTag.user.js/issues)までよろしくお願いします。

お問い合わせは、Twitter [@syusui\_s](https://twitter.com/syusui_s/)か、<mailto:syusui.s[a]gmail.com>まで。

ライセンス
-----
MIT LICENSEで公開します。LICENSEファイルをご覧ください。
